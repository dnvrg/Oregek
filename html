<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Care Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4a5568;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-call {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn-delete {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .patient-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .patient-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }

        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .patient-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .calendar-header {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .calendar-visit {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 10px;
            margin-bottom: 2px;
            display: block;
        }

        .shopping-list {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .shopping-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .note-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .note-date {
            color: #718096;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-tab {
                font-size: 14px;
                padding: 10px 16px;
            }
        }

        .visit-days {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .color-picker {
            width: 50px !important;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Elderly Care Manager</h1>
            <p>Comprehensive care management system for social workers</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('patients')">Patients</button>
            <button class="nav-tab" onclick="showTab('calendar')">Calendar</button>
            <button class="nav-tab" onclick="showTab('shopping')">Shopping List</button>
            <button class="nav-tab" onclick="showTab('documents')">Documents</button>
            <button class="nav-tab" onclick="showTab('notes')">Notes</button>
        </div>

        <!-- Patients Tab -->
        <div id="patients" class="tab-content active">
            <h2>Patient Management</h2>
            
            <form id="patientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Address</label>
                    <input type="text" id="address">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="intercom">Intercom Code</label>
                        <input type="text" id="intercom">
                    </div>
                    <div class="form-group">
                        <label for="taj">TAJ Number</label>
                        <input type="text" id="taj">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="emergencyContact">Emergency Contact</label>
                        <input type="text" id="emergencyContact">
                    </div>
                    <div class="form-group">
                        <label for="emergencyPhone">Emergency Contact Phone</label>
                        <input type="tel" id="emergencyPhone">
                    </div>
                </div>

                <div class="form-group">
                    <label for="tasks">Tasks</label>
                    <textarea id="tasks" placeholder="List the patient's care tasks..."></textarea>
                </div>

                <div class="form-group">
                    <label for="patientColor">Calendar Color</label>
                    <input type="color" id="patientColor" class="color-picker" value="#667eea">
                </div>

                <div class="form-group">
                    <label>Visit Days</label>
                    <div class="visit-days">
                        <div class="day-checkbox">
                            <input type="checkbox" id="monday" value="1">
                            <label for="monday">Monday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="tuesday" value="2">
                            <label for="tuesday">Tuesday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="wednesday" value="3">
                            <label for="wednesday">Wednesday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="thursday" value="4">
                            <label for="thursday">Thursday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="friday" value="5">
                            <label for="friday">Friday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="saturday" value="6">
                            <label for="saturday">Saturday</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="sunday" value="0">
                            <label for="sunday">Sunday</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">Add Patient</button>
                <button type="button" class="btn" onclick="clearForm()">Clear Form</button>
            </form>

            <div id="patientsList" class="patient-list"></div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <h2>Visit Calendar</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="calendarMonth">Month</label>
                    <select id="calendarMonth">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="calendarYear">Year</label>
                    <input type="number" id="calendarYear" min="2020" max="2030">
                </div>
            </div>
            <div id="calendarGrid" class="calendar"></div>
        </div>

        <!-- Shopping List Tab -->
        <div id="shopping" class="tab-content">
            <h2>Shopping List</h2>
            
            <form id="shoppingForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="shoppingItem">Item</label>
                        <input type="text" id="shoppingItem" required>
                    </div>
                    <div class="form-group">
                        <label for="shoppingPatient">Patient</label>
                        <select id="shoppingPatient">
                            <option value="">Select Patient</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn">Add Item</button>
            </form>

            <div id="shoppingList"></div>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-content">
            <h2>Patient Documents</h2>
            
            <form id="documentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="documentFile">Select Document</label>
                        <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                    </div>
                    <div class="form-group">
                        <label for="documentPatient">Patient</label>
                        <select id="documentPatient" required>
                            <option value="">Select Patient</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn">Upload Document</button>
            </form>

            <div id="documentsList"></div>
        </div>

        <!-- Notes Tab -->
        <div id="notes" class="tab-content">
            <h2>Notes</h2>
            
            <form id="noteForm">
                <div class="form-group">
                    <label for="notePatient">Patient</label>
                    <select id="notePatient">
                        <option value="">General Note</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="noteContent">Note</label>
                    <textarea id="noteContent" required placeholder="Enter your note here..."></textarea>
                </div>
                <button type="submit" class="btn">Add Note</button>
            </form>

            <div id="notesList"></div>
        </div>
    </div>

    <script>
        // Data storage
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let shoppingItems = JSON.parse(localStorage.getItem('shoppingItems')) || [];
        let documents = JSON.parse(localStorage.getItem('documents')) || [];
        let notes = JSON.parse(localStorage.getItem('notes')) || [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...'); // Debug log
            
            // Load data from localStorage
            try {
                const storedPatients = localStorage.getItem('patients');
                const storedShoppingItems = localStorage.getItem('shoppingItems');
                const storedDocuments = localStorage.getItem('documents');
                const storedNotes = localStorage.getItem('notes');
                
                patients = storedPatients ? JSON.parse(storedPatients) : [];
                shoppingItems = storedShoppingItems ? JSON.parse(storedShoppingItems) : [];
                documents = storedDocuments ? JSON.parse(storedDocuments) : [];
                notes = storedNotes ? JSON.parse(storedNotes) : [];
                
                console.log('Loaded patients from storage:', patients); // Debug log
                console.log('LocalStorage available:', typeof(Storage) !== "undefined"); // Debug log
                
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                // Initialize with empty arrays if there's an error
                patients = [];
                shoppingItems = [];
                documents = [];
                notes = [];
            }
            
            // Render all components
            renderPatients();
            renderShoppingList();
            renderDocuments();
            renderNotes();
            updatePatientSelects();
            initializeCalendar();
            generateCalendar();
            
            console.log('App initialized successfully'); // Debug log
        });

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'calendar') {
                generateCalendar();
            }
        }

        // Patient management
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            
            // Validate required fields
            if (!nameInput.value.trim()) {
                alert('Please enter the patient name.');
                nameInput.focus();
                return;
            }
            
            if (!phoneInput.value.trim()) {
                alert('Please enter the phone number.');
                phoneInput.focus();
                return;
            }
            
            // Get visit days
            const visitDays = [];
            const dayCheckboxes = document.querySelectorAll('.day-checkbox input[type="checkbox"]:checked');
            dayCheckboxes.forEach(checkbox => {
                visitDays.push(parseInt(checkbox.value));
            });

            // Create patient object
            const patient = {
                id: Date.now(),
                name: nameInput.value.trim(),
                phone: phoneInput.value.trim(),
                address: document.getElementById('address').value.trim(),
                intercom: document.getElementById('intercom').value.trim(),
                taj: document.getElementById('taj').value.trim(),
                emergencyContact: document.getElementById('emergencyContact').value.trim(),
                emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
                tasks: document.getElementById('tasks').value.trim(),
                color: document.getElementById('patientColor').value,
                visitDays: visitDays,
                createdDate: new Date().toISOString()
            };

            console.log('Adding patient:', patient); // Debug log
            
            try {
                // Add to patients array
                patients.push(patient);
                
                // Save to localStorage
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Verify save
                const saved = JSON.parse(localStorage.getItem('patients'));
                console.log('Patients saved to localStorage:', saved); // Debug log
                
                // Update UI
                renderPatients();
                updatePatientSelects();
                generateCalendar();
                clearForm();
                
                // Show success message
                alert(`Patient ${patient.name} has been added successfully!`);
                
            } catch (error) {
                console.error('Error saving patient:', error);
                alert('Error saving patient. Please try again.');
            }
        });

        function renderPatients() {
            const container = document.getElementById('patientsList');
            container.innerHTML = '';

            console.log('Rendering patients:', patients); // Debug log

            if (patients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No patients added yet. Use the form above to add your first patient.</p>';
                return;
            }

            patients.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';
                card.style.borderLeftColor = patient.color || '#667eea';
                
                const visitDaysText = getVisitDaysText(patient.visitDays || []);
                
                card.innerHTML = `
                    <div class="patient-name">${patient.name}</div>
                    <p><strong>Phone:</strong> ${patient.phone}</p>
                    <p><strong>Address:</strong> ${patient.address || 'Not provided'}</p>
                    <p><strong>Intercom:</strong> ${patient.intercom || 'Not provided'}</p>
                    <p><strong>TAJ:</strong> ${patient.taj || 'Not provided'}</p>
                    <p><strong>Emergency Contact:</strong> ${patient.emergencyContact || 'Not provided'}</p>
                    <p><strong>Emergency Phone:</strong> ${patient.emergencyPhone || 'Not provided'}</p>
                    <p><strong>Tasks:</strong> ${patient.tasks || 'None specified'}</p>
                    <p><strong>Visit Days:</strong> ${visitDaysText}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-call" onclick="callPatient('${patient.phone}')">ðŸ“ž Call</button>
                        <button class="btn" onclick="editPatient(${patient.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deletePatient(${patient.id})">Delete</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function getVisitDaysText(days) {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days.map(day => dayNames[day]).join(', ') || 'No scheduled visits';
        }

        function callPatient(phone) {
            window.location.href = `tel:${phone}`;
        }

        function deletePatient(id) {
            const patient = patients.find(p => p.id === id);
            if (confirm(`Are you sure you want to delete ${patient ? patient.name : 'this patient'}?`)) {
                patients = patients.filter(p => p.id !== id);
                localStorage.setItem('patients', JSON.stringify(patients));
                renderPatients();
                updatePatientSelects();
                generateCalendar(); // Refresh calendar when patient is deleted
                alert('Patient deleted successfully!');
            }
        }

        function clearForm() {
            document.getElementById('patientForm').reset();
            
            // Uncheck all day checkboxes
            document.querySelectorAll('.day-checkbox input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset color picker to default
            document.getElementById('patientColor').value = '#667eea';
            
            console.log('Form cleared'); // Debug log
        }

        function editPatient(id) {
            const patient = patients.find(p => p.id === id);
            if (!patient) return;
            
            // Populate form with patient data
            document.getElementById('name').value = patient.name;
            document.getElementById('phone').value = patient.phone;
            document.getElementById('address').value = patient.address || '';
            document.getElementById('intercom').value = patient.intercom || '';
            document.getElementById('taj').value = patient.taj || '';
            document.getElementById('emergencyContact').value = patient.emergencyContact || '';
            document.getElementById('emergencyPhone').value = patient.emergencyPhone || '';
            document.getElementById('tasks').value = patient.tasks || '';
            document.getElementById('patientColor').value = patient.color || '#667eea';
            
            // Set visit days
            document.querySelectorAll('.day-checkbox input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = patient.visitDays && patient.visitDays.includes(parseInt(checkbox.value));
            });
            
            // Remove the patient from array (will be re-added when form is submitted)
            patients = patients.filter(p => p.id !== id);
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Scroll to form
            document.getElementById('patientForm').scrollIntoView({ behavior: 'smooth' });
            
            alert('Patient loaded for editing. Update the information and click "Add Patient" to save changes.');
        }

        function updatePatientSelects() {
            const selects = ['shoppingPatient', 'documentPatient', 'notePatient'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Clear existing options except the first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    option.textContent = patient.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // Calendar functionality
        function initializeCalendar() {
            const now = new Date();
            document.getElementById('calendarMonth').value = now.getMonth();
            document.getElementById('calendarYear').value = now.getFullYear();
            
            document.getElementById('calendarMonth').addEventListener('change', generateCalendar);
            document.getElementById('calendarYear').addEventListener('change', generateCalendar);
        }

        function generateCalendar() {
            const month = parseInt(document.getElementById('calendarMonth').value);
            const year = parseInt(document.getElementById('calendarYear').value);
            
            if (isNaN(month) || isNaN(year)) return;
            
            const calendar = document.getElementById('calendarGrid');
            calendar.innerHTML = '';
            
            // Add header
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Generate calendar days (6 weeks = 42 days)
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = currentDate.getDate();
                
                if (currentDate.getMonth() !== month) {
                    dayElement.style.opacity = '0.3';
                }
                
                // Highlight today
                const today = new Date();
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.style.backgroundColor = '#f0f8ff';
                    dayElement.style.border = '2px solid #667eea';
                }
                
                dayElement.appendChild(dayNumber);
                
                // Add visits for this day
                const dayOfWeek = currentDate.getDay();
                patients.forEach(patient => {
                    if (patient.visitDays && patient.visitDays.includes(dayOfWeek)) {
                        const visit = document.createElement('span');
                        visit.className = 'calendar-visit';
                        visit.textContent = patient.name;
                        visit.style.backgroundColor = patient.color || '#667eea';
                        visit.style.color = 'white';
                        visit.title = `Visit: ${patient.name}`;
                        dayElement.appendChild(visit);
                    }
                });
                
                calendar.appendChild(dayElement);
            }
        }

        // Shopping list functionality
        document.getElementById('shoppingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const item = {
                id: Date.now(),
                item: document.getElementById('shoppingItem').value,
                patientId: document.getElementById('shoppingPatient').value,
                completed: false
            };
            
            shoppingItems.push(item);
            localStorage.setItem('shoppingItems', JSON.stringify(shoppingItems));
            renderShoppingList();
            document.getElementById('shoppingForm').reset();
        });

        function renderShoppingList() {
            const container = document.getElementById('shoppingList');
            container.innerHTML = '';
            
            shoppingItems.forEach(item => {
                const patient = patients.find(p => p.id == item.patientId);
                const patientName = patient ? patient.name : 'General';
                
                const itemElement = document.createElement('div');
                itemElement.className = 'shopping-item';
                itemElement.innerHTML = `
                    <div>
                        <strong>${item.item}</strong>
                        <div style="font-size: 14px; color: #718096;">For: ${patientName}</div>
                    </div>
                    <button class="btn btn-delete" onclick="deleteShoppingItem(${item.id})">Remove</button>
                `;
                
                const listElement = document.createElement('div');
                listElement.className = 'shopping-list';
                listElement.appendChild(itemElement);
                container.appendChild(listElement);
            });
        }

        function deleteShoppingItem(id) {
            shoppingItems = shoppingItems.filter(item => item.id !== id);
            localStorage.setItem('shoppingItems', JSON.stringify(shoppingItems));
            renderShoppingList();
        }

        // Document management
        document.getElementById('documentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('documentFile');
            const file = fileInput.files[0];
            const patientId = document.getElementById('documentPatient').value;
            
            if (!file) {
                alert('Please select a file to upload.');
                return;
            }
            
            if (!patientId) {
                alert('Please select a patient for this document.');
                return;
            }
            
            // Show loading indicator
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const documentObj = {
                        id: Date.now(),
                        name: file.name,
                        patientId: parseInt(patientId),
                        data: e.target.result,
                        type: file.type,
                        size: file.size,
                        uploadDate: new Date().toLocaleString()
                    };
                    
                    documents.push(documentObj);
                    localStorage.setItem('documents', JSON.stringify(documents));
                    renderDocuments();
                    
                    // Reset form
                    document.getElementById('documentForm').reset();
                    
                    // Show success message
                    alert('Document uploaded successfully!');
                } catch (error) {
                    console.error('Error saving document:', error);
                    alert('Error uploading document. Please try again.');
                } finally {
                    // Reset button
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            };
            
            reader.readAsDataURL(file);
        });

        function renderDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '';
            
            if (documents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No documents uploaded yet.</p>';
                return;
            }
            
            // Sort documents alphabetically by name
            const sortedDocs = [...documents].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedDocs.forEach(doc => {
                const patient = patients.find(p => p.id == doc.patientId);
                const patientName = patient ? patient.name : 'Unknown Patient';
                
                // Format file size
                const fileSize = doc.size ? formatFileSize(doc.size) : 'Unknown size';
                
                const docElement = document.createElement('div');
                docElement.className = 'document-item';
                docElement.innerHTML = `
                    <div>
                        <strong>${doc.name}</strong>
                        <div style="font-size: 14px; color: #718096;">
                            Patient: ${patientName} | Size: ${fileSize} | Uploaded: ${doc.uploadDate}
                        </div>
                    </div>
                    <div>
                        <button class="btn" onclick="viewDocument(${doc.id})">View</button>
                        <button class="btn" onclick="downloadDocument(${doc.id})">Download</button>
                        <button class="btn btn-delete" onclick="deleteDocument(${doc.id})">Delete</button>
                    </div>
                `;
                
                container.appendChild(docElement);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function viewDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (doc) {
                // Open document in new window/tab
                const newWindow = window.open();
                if (doc.type.startsWith('image/')) {
                    newWindow.document.write(`
                        <html>
                            <head><title>${doc.name}</title></head>
                            <body style="margin:0; display:flex; justify-content:center; align-items:center; min-height:100vh; background:#f0f0f0;">
                                <img src="${doc.data}" style="max-width:100%; max-height:100%; object-fit:contain;" alt="${doc.name}">
                            </body>
                        </html>
                    `);
                } else if (doc.type === 'application/pdf') {
                    newWindow.location.href = doc.data;
                } else {
                    // For other file types, trigger download
                    downloadDocument(id);
                    newWindow.close();
                }
            }
        }

        function downloadDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (doc) {
                const link = document.createElement('a');
                link.href = doc.data;
                link.download = doc.name;
                link.click();
            }
        }

        function deleteDocument(id) {
            if (confirm('Are you sure you want to delete this document?')) {
                documents = documents.filter(d => d.id !== id);
                localStorage.setItem('documents', JSON.stringify(documents));
                renderDocuments();
            }
        }

        // Notes functionality
        document.getElementById('noteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const note = {
                id: Date.now(),
                content: document.getElementById('noteContent').value,
                patientId: document.getElementById('notePatient').value,
                date: new Date().toLocaleString()
            };
            
            notes.push(note);
            localStorage.setItem('notes', JSON.stringify(notes));
            renderNotes();
            document.getElementById('noteForm').reset();
        });

        function renderNotes() {
            const container = document.getElementById('notesList');
            container.innerHTML = '';
            
            // Sort notes by date (newest first)
            const sortedNotes = [...notes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedNotes.forEach(note => {
                const patient = patients.find(p => p.id == note.patientId);
                const patientName = patient ? patient.name : 'General';
                
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                noteElement.innerHTML = `
                    <div class="note-header">
                        <strong>Note for: ${patientName}</strong>
                        <div>
                            <span class="note-date">${note.date}</span>
                            <button class="btn btn-delete" onclick="deleteNote(${note.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                        </div>
                    </div>
                    <div>${note.content}</div>
                `;
                
                container.appendChild(noteElement);
            });
        }

        function deleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(n => n.id !== id);
                localStorage.setItem('notes', JSON.stringify(notes));
                renderNotes();
            }
        }

        // Service Worker for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(err => {
                console.log('Service Worker registration failed:', err);
            });
        }
    </script>
</body>
</html>
